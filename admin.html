<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli</title>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f4f4f4; }
        #login-screen { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #admin-panel { display: none; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-login { background-color: #3498db; }
        .btn-logout { background-color: #c0392b; width: auto; float: right; padding: 8px 15px; font-size: 14px; }
        .btn-add { background-color: #27ae60; }
        .btn-update { background-color: #e67e22; display: none; }
        .btn-cancel { background-color: #7f8c8d; display: none; }
        .error { color: red; font-size: 14px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #333; color: white; }
        img.thumb { width: 40px; height: 40px; object-fit: cover; }
        .action-btn { padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; margin-right: 5px; width: auto; font-size: 12px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Yönetici Girişi</h2>
        <input type="email" id="email" placeholder="E-posta Adresi">
        <input type="password" id="password" placeholder="Şifre">
        <button onclick="login()" class="btn-login">GİRİŞ YAP</button>
        <p id="login-error" class="error"></p>
    </div>

    <div id="admin-panel">
        <div class="container" style="overflow: hidden;">
            <h2 style="float: left; margin: 0;">Ürün Yönetimi</h2>
            <button onclick="logout()" class="btn-logout">Çıkış Yap</button>
        </div>

        <div class="container">
            <h3 id="form-title">Yeni Ürün Ekle</h3>
            <input type="hidden" id="docId">
            <input type="text" id="urunAdi" placeholder="Ürün Adı">
            <input type="text" id="urunFiyat" placeholder="Fiyat (Örn: 90 TL)">
            <select id="urunKategori">
                <option value="Sıcak İçecekler">Sıcak İçecekler</option>
                <option value="Soğuk İçecekler">Soğuk İçecekler</option>
                <option value="Tatlılar">Tatlılar</option>
                <option value="Aperatif">Aperatif</option>
                <option value="İnternet Kafe">İnternet Kafe</option>
            </select>
            <textarea id="urunTanim" placeholder="Açıklama" rows="2"></textarea>
            <input type="text" id="urunResim" placeholder="Resim Linki">
            <button onclick="saveProduct()" id="btn-save" class="btn-add">ÜRÜNÜ EKLE</button>
            <button onclick="updateProduct()" id="btn-update" class="btn-update">GÜNCELLE KAYDET</button>
            <button onclick="cancelEdit()" id="btn-cancel" class="btn-cancel">İPTAL</button>
        </div>

        <div class="container">
            <h3>Mevcut Liste</h3>
            <table id="product-table">
                <thead><tr><th>Resim</th><th>Ürün</th><th>Fiyat</th><th>İşlem</th></tr></thead>
                <tbody id="product-list"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // ÖNEMLİ: Artık firebaseConfig aramıyoruz, direkt auth ve db alıyoruz
        import { auth, db } from "./firebase-config.js";
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // GİRİŞ KONTROLÜ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Giriş yapılmış:", user.email);
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("admin-panel").style.display = "block";
                listenData();
            } else {
                console.log("Giriş bekleniyor...");
                document.getElementById("login-screen").style.display = "block";
                document.getElementById("admin-panel").style.display = "none";
            }
        });

        // GİRİŞ FONKSİYONU
        window.login = () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    document.getElementById("login-error").innerText = "Hatalı e-posta veya şifre!";
                    console.error(error);
                });
        };

        // ÇIKIŞ FONKSİYONU
        window.logout = () => signOut(auth);

        function listenData() {
    onSnapshot(collection(db, "menu"), (snapshot) => {
        let docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // --- SIRALAMA KODU (Admin İçin) ---
        docs.sort((a, b) => {
            let fiyatA = parseFloat(a.Fiyat.toString().replace(/[^0-9.]/g, '')) || 0;
            let fiyatB = parseFloat(b.Fiyat.toString().replace(/[^0-9.]/g, '')) || 0;
            return fiyatA - fiyatB;
        });
        // ----------------------------------

        const list = document.getElementById("product-list");
        list.innerHTML = "";
        
        docs.forEach(data => {
            list.innerHTML += `
                <tr>
                    <td><img src="${data.Resim || 'https://via.placeholder.com/40'}" class="thumb"></td>
                    <td>${data.isim} <br> <small>${data.Kategori}</small></td>
                    <td>${data.Fiyat}</td>
                    <td>
                        <button class="action-btn" style="background:#f39c12" onclick="editMode('${data.id}', '${data.isim}', '${data.Fiyat}', '${data.Kategori}', '${data.Tanım||''}', '${data.Resim||''}')">Düzenle</button>
                        <button class="action-btn" style="background:#e74c3c" onclick="del('${data.id}')">Sil</button>
                    </td>
                </tr>
            `;
        });
    });
}
        // CRUD İŞLEMLERİ
        window.saveProduct = async () => {
            try {
                await addDoc(collection(db, "menu"), {
                    isim: document.getElementById("urunAdi").value,
                    Fiyat: document.getElementById("urunFiyat").value,
                    Kategori: document.getElementById("urunKategori").value,
                    Tanım: document.getElementById("urunTanim").value,
                    Resim: document.getElementById("urunResim").value
                });
                alert("Eklendi!");
                clearForm();
            } catch(e) { alert(e.message); }
        };

        window.updateProduct = async () => {
            const id = document.getElementById("docId").value;
            try {
                await updateDoc(doc(db, "menu", id), {
                    isim: document.getElementById("urunAdi").value,
                    Fiyat: document.getElementById("urunFiyat").value,
                    Kategori: document.getElementById("urunKategori").value,
                    Tanım: document.getElementById("urunTanim").value,
                    Resim: document.getElementById("urunResim").value
                });
                alert("Güncellendi!");
                cancelEdit();
            } catch(e) { alert(e.message); }
        };

        window.del = async (id) => {
            if(confirm("Silinecek?")) await deleteDoc(doc(db, "menu", id));
        };

        // FORM YARDIMCILARI
        window.editMode = (id, ad, fy, kat, tan, res) => {
            document.getElementById("docId").value = id;
            document.getElementById("urunAdi").value = ad;
            document.getElementById("urunFiyat").value = fy;
            document.getElementById("urunKategori").value = kat;
            document.getElementById("urunTanim").value = tan;
            document.getElementById("urunResim").value = res;
            
            toggleBtns(true);
            document.getElementById("form-title").innerText = "Ürünü Düzenle";
            window.scrollTo(0,0);
        };

        window.cancelEdit = () => {
            clearForm();
            toggleBtns(false);
            document.getElementById("form-title").innerText = "Yeni Ürün Ekle";
        };

        function toggleBtns(editMode) {
            document.getElementById("btn-save").style.display = editMode ? "none" : "block";
            document.getElementById("btn-update").style.display = editMode ? "block" : "none";
            document.getElementById("btn-cancel").style.display = editMode ? "block" : "none";
        }

        function clearForm() {
            document.getElementById("docId").value = "";
            document.getElementById("urunAdi").value = "";
            document.getElementById("urunFiyat").value = "";
            document.getElementById("urunTanim").value = "";
            document.getElementById("urunResim").value = "";
        }
    </script>
</body>
</html>